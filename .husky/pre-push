set -euo pipefail

# --------------------------
# CONFIGURATION
# --------------------------
CONFIG_FILE="${GIT_DIR:-.git}/hooks/prepush.config"

# Default configuration
SCM_BASE_BRANCH="main"
CACHE_DIR="${GIT_DIR:-.git}/turbo-scm-cache"
CACHE_TTL_SECONDS=$((3600))

# Load config if exists
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

echo "ğŸš€ Pre-push checks"

# Ensure essential commands exist
command -v bun >/dev/null 2>&1 || { echo "âŒ bun not found in PATH"; exit 1; }
command -v turbo >/dev/null 2>&1 || { echo "âŒ turbo not found in PATH"; exit 1; }

# Determine current branch
git fetch origin "$SCM_BASE_BRANCH" --quiet || true
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
echo "Current branch: $CURRENT_BRANCH"

# Exit early if nothing changed
if git diff --quiet "origin/$SCM_BASE_BRANCH...HEAD"; then
  echo "âœ¨ No changes since origin/$SCM_BASE_BRANCH. Skipping checks."
  exit 0
fi

# --------------------------
# SCM CACHE MANAGEMENT
# --------------------------
mkdir -p "$CACHE_DIR"
CACHE_FILE="$CACHE_DIR/lastrun"
CURRENT_TIME=$(date +%s)
echo "$CURRENT_TIME" > "$CACHE_FILE"
echo "ğŸ’¾ SCM cache updated"

# --------------------------
# CONCURRENCY
# --------------------------
CORES=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
CONC=$(( CORES / 2 ))
[ "$CONC" -lt 1 ] && CONC=1

# --------------------------
# RUN ALL CHECKS
# --------------------------
TURBO_FLAGS="--concurrency=$CONC --cache=local:rw,remote:r"

echo "ğŸ“ Running lint/format/type checks..."
TURBO_SCM_BASE="$SCM_BASE_BRANCH" bun run turbo run check --affected $TURBO_FLAGS
TURBO_SCM_BASE="$SCM_BASE_BRANCH" bun run turbo run check-types --affected $TURBO_FLAGS

echo "ğŸ§ª Running tests..."
TURBO_SCM_BASE="$SCM_BASE_BRANCH" bun run turbo run test --affected $TURBO_FLAGS

echo "ğŸ—ï¸ Running builds..."
TURBO_SCM_BASE="$SCM_BASE_BRANCH" bun run turbo run build --affected --cache=local:rw,remote:r

echo "ğŸ”’ Running security audit..."
bun run security:audit

echo "âœ… All pre-push checks passed."
exit 0
